本项目基于UDP实现了一个简单的有连接双工稳定传输协议。

# 包
## 结构
协议的包结构如下所示：

| 4 bytes | 1 byte | ...  |
|---------|--------|------|
| CRC32   | Type   | Data |

收到包时首先对包检查CRC32校验和，并直接丢弃损坏的包。
## 种类
当前的协议中有以下种类的包：

| 种类   | 意义             |
|--------|------------------|
| Syn    | 请求建立连接     |
| SynAck | 确认建立连接     |
| Data   | 传输数据         |
| Ack    | 确认收到数据     |
| Fin    | 通知己侧连接关闭 |
| FinAck | 确认对侧连接关闭 |

尽管是非必须的，但目前所有种类的包中都带有序列号。不过，只有在发送Data类型的包时会递增序列号。

除此之外，Data类型的包里带有需要传输的数据，Ack类型的包里则带有一个确认号。

# 协议规范
## 连接建立
以下用C指代主动建立连接的一方，S代表另一方，连接通过两步握手完成，即：

C->S Syn

S->C SynAck

C发出Syn后等待S回复，收到后连接即正式建立，若等待至超时则再次发送Syn
## 数据发送
数据以Data包为单位发送，每个Data包发送后，之后发送的包的序列号增加1。

大量数据的发送使用滑动窗口方式，发送完整个窗口的内容后等待对侧回复Ack，代表序列号小于等于Ack中确认号的包都已经被接收完毕，将窗口向后滑动，重复此过程。若等待至超时则重传当前整个窗口中的数据。目前协议没有拥塞控制功能，窗口的大小是事先固定的。

Ack的发送是定时的，即使连接闲置也以按周期不断发送，起到接收确认和保持连接活跃的双重作用。
## 连接关闭
连接的关闭从主动关闭一方的单侧关闭开始，主动关闭的一方停止发送任何数据，并发送一个Fin包，等待对侧回复FinAck，超时重发。

一侧关闭之后，另一侧继续发送其余数据，发送完后另一侧也进行单侧关闭，单侧关闭流程与上一步相同。

当连接的任何一方观察到双侧关闭状态，其将最后等待若干重传周期的时间，以回复可能被重传的Fin，此后连接正常结束。

# 网络环境模拟
程序中实现了对丢包、乱序与包损坏的模拟，测试表明我们的协议在这些问题下仍能进行可靠的传输。

具体地，我们首先实现了一个网络处理层，为协议自动机提供收发数据包的统一接口，同时也模拟网路中间设备。随后，我们给出了这一网络处理层的一个特殊实现，在其中我们以一定的概率随机静默地丢弃、损坏与重排序协议将要发出的包。通过在连接的双方分别使用这一网络处理层，我们能够模拟在不良网络状态下双方程序发出的包被中间设备静默丢弃、损坏与重排序的情况。

经过测试，在无回应静默发生的丢包、坏包与包重排问题下，我们的协议仍然可以通过重传机制、校验和与重组来达到可靠的数据传输。
